<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam System Analytics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
        }
        .stat-card h2 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-card p {
            font-size: 1.1rem;
            color: #6c757d;
        }
        .bg-purple {
            background-color: #7952b3;
            color: white;
        }
        .bg-blue {
            background-color: #0d6efd;
            color: white;
        }
        .bg-green {
            background-color: #198754;
            color: white;
        }
        .bg-orange {
            background-color: #fd7e14;
            color: white;
        }
        .bg-red {
            background-color: #dc3545;
            color: white;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        .date-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #0d6efd;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Online Exam System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="admin.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="analytics.html">Analytics</a>
                    </li>
                </ul>
                <span class="navbar-text">
                    <a href="index.html" class="btn btn-outline-light btn-sm">Logout</a>
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4">Exam System Analytics</h1>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="filter-section">
                    <h5>Filters</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="date-filter">
                                <div class="form-group">
                                    <label for="startDate">Start Date</label>
                                    <input type="date" id="startDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="endDate">End Date</label>
                                    <input type="date" id="endDate" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="examFilter">Filter by Exam</label>
                                <select id="examFilter" class="form-select">
                                    <option value="">All Exams</option>
                                    <!-- Exams will be loaded here -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button id="applyFilters" class="btn btn-primary w-100">Apply Filters</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card bg-purple">
                    <h2 id="totalStudents">0</h2>
                    <p>Total Students</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-blue">
                    <h2 id="totalExams">0</h2>
                    <p>Total Exams</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-green">
                    <h2 id="activeExams">0</h2>
                    <p>Active Exams</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-orange">
                    <h2 id="avgScore">0%</h2>
                    <p>Average Score</p>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4" id="analyticsTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#overviewTab">Overview</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#studentsTab">Student Performance</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#examsTab">Exam Statistics</a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overviewTab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Exam Participation</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="examParticipationChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="card-title mb-0">Average Scores by Exam</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="examScoresChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0">Top Performing Students</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Student Name</th>
                                                <th>Average Score</th>
                                                <th>Exams Taken</th>
                                                <th>Highest Score</th>
                                                <th>Lowest Score</th>
                                            </tr>
                                        </thead>
                                        <tbody id="topStudentsTable">
                                            <!-- Top students will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Tab -->
            <div class="tab-pane fade" id="studentsTab">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Student Performance</h5>
                                <div class="form-group mb-0">
                                    <input type="text" id="studentSearch" class="form-control" placeholder="Search students...">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Student ID</th>
                                                <th>Name</th>
                                                <th>Average Score</th>
                                                <th>Exams Taken</th>
                                                <th>Highest Score</th>
                                                <th>Lowest Score</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentPerformanceTable">
                                            <!-- Student performance data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card" id="studentDetailCard" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0" id="studentDetailName">Student Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="studentProgressChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Exam</th>
                                                        <th>Date</th>
                                                        <th>Score</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="studentExamsTable">
                                                    <!-- Student exam details will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exams Tab -->
            <div class="tab-pane fade" id="examsTab">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Exam Statistics</h5>
                                <div class="form-group mb-0">
                                    <input type="text" id="examSearch" class="form-control" placeholder="Search exams...">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Exam ID</th>
                                                <th>Title</th>
                                                <th>Participants</th>
                                                <th>Average Score</th>
                                                <th>Highest Score</th>
                                                <th>Lowest Score</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="examStatisticsTable">
                                            <!-- Exam statistics will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card" id="examDetailCard" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0" id="examDetailTitle">Exam Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="scoreDistributionChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="questionPerformanceChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let analyticsData = null;
        let allExams = [];
        let allStudents = [];
        let allResults = [];
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('endDate').valueAsDate = today;
            document.getElementById('startDate').valueAsDate = thirtyDaysAgo;
            
            // Load initial data
            loadAnalyticsData();
            loadExams();
            
            // Set up event listeners
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('studentSearch').addEventListener('input', filterStudents);
            document.getElementById('examSearch').addEventListener('input', filterExams);
        });
        
        // Load analytics data
        function loadAnalyticsData() {
            fetch('/analytics?role=admin')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch analytics data');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        analyticsData = data;
                        updateDashboard(data);
                    } else {
                        showError('Failed to load analytics data: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('Failed to load analytics data: ' + error.message);
                });
        }
        
        // Load exams for filter dropdown
        function loadExams() {
            fetch('/exams')
                .then(response => response.json())
                .then(data => {
                    allExams = data;
                    const examFilter = document.getElementById('examFilter');
                    
                    // Clear existing options except the first one
                    while (examFilter.options.length > 1) {
                        examFilter.remove(1);
                    }
                    
                    // Add exam options
                    data.forEach(exam => {
                        const option = document.createElement('option');
                        option.value = exam.id;
                        option.textContent = exam.title;
                        examFilter.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading exams:', error);
                });
        }
        
        // Apply filters
        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const examId = document.getElementById('examFilter').value;
            
            // Construct query parameters
            let queryParams = 'role=admin';
            if (startDate && endDate) {
                queryParams += `&startDate=${startDate}&endDate=${endDate}`;
            }
            if (examId) {
                queryParams += `&examId=${examId}`;
            }
            
            // Fetch filtered data
            fetch(`/analytics?${queryParams}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        analyticsData = data;
                        updateDashboard(data);
                    } else {
                        showError('Failed to apply filters: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error applying filters:', error);
                    showError('Failed to apply filters: ' + error.message);
                });
        }
        
        // Update dashboard with analytics data
        function updateDashboard(data) {
            // Update overview statistics
            document.getElementById('totalStudents').textContent = data.overview.totalStudents;
            document.getElementById('totalExams').textContent = data.overview.totalExams;
            document.getElementById('activeExams').textContent = data.overview.activeExams;
            document.getElementById('avgScore').textContent = data.overview.averageScore + '%';
            
            // Update top students table
            updateTopStudentsTable(data.topStudents);
            
            // Update student performance table
            updateStudentPerformanceTable(data.topStudents);
            
            // Update exam statistics table
            updateExamStatisticsTable(data.examStatistics);
            
            // Create or update charts
            createExamParticipationChart(data.examStatistics);
            createExamScoresChart(data.examStatistics);
        }
        
        // Update top students table
        function updateTopStudentsTable(students) {
            const tableBody = document.getElementById('topStudentsTable');
            tableBody.innerHTML = '';
            
            students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.name}</td>
                    <td>${student.averageScore}%</td>
                    <td>${student.examsTaken}</td>
                    <td>${student.highestScore}%</td>
                    <td>${student.lowestScore}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Update student performance table
        function updateStudentPerformanceTable(students) {
            const tableBody = document.getElementById('studentPerformanceTable');
            tableBody.innerHTML = '';
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.studentId}</td>
                    <td>${student.name}</td>
                    <td>${student.averageScore}%</td>
                    <td>${student.examsTaken}</td>
                    <td>${student.highestScore}%</td>
                    <td>${student.lowestScore}%</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-student" data-student-id="${student.studentId}">View Details</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-student').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-student-id');
                    showStudentDetails(studentId);
                });
            });
        }
        
        // Update exam statistics table
        function updateExamStatisticsTable(exams) {
            const tableBody = document.getElementById('examStatisticsTable');
            tableBody.innerHTML = '';
            
            exams.forEach(exam => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${exam.examId}</td>
                    <td>${exam.title}</td>
                    <td>${exam.participants}</td>
                    <td>${exam.averageScore}%</td>
                    <td>${exam.highestScore}%</td>
                    <td>${exam.lowestScore}%</td>
                    <td>
                        <span class="badge ${exam.active ? 'bg-success' : 'bg-secondary'}">
                            ${exam.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary view-exam" data-exam-id="${exam.examId}">View Details</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-exam').forEach(button => {
                button.addEventListener('click', function() {
                    const examId = this.getAttribute('data-exam-id');
                    showExamDetails(examId);
                });
            });
        }
        
        // Create exam participation chart
        function createExamParticipationChart(exams) {
            const ctx = document.getElementById('examParticipationChart').getContext('2d');
            
            // Sort exams by participants (descending) and take top 5
            const topExams = [...exams]
                .sort((a, b) => b.participants - a.participants)
                .slice(0, 5);
            
            const labels = topExams.map(exam => exam.title);
            const data = topExams.map(exam => exam.participants);
            
            // Destroy existing chart if it exists
            if (window.examParticipationChart) {
                window.examParticipationChart.destroy();
            }
            
            window.examParticipationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Participants',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Exam Title'
                            }
                        }
                    }
                }
            });
        }
        
        // Create exam scores chart
        function createExamScoresChart(exams) {
            const ctx = document.getElementById('examScoresChart').getContext('2d');
            
            // Sort exams by participants (descending) and take top 5
            const topExams = [...exams]
                .sort((a, b) => b.participants - a.participants)
                .slice(0, 5);
            
            const labels = topExams.map(exam => exam.title);
            const avgScores = topExams.map(exam => exam.averageScore);
            const highScores = topExams.map(exam => exam.highestScore);
            const lowScores = topExams.map(exam => exam.lowestScore);
            
            // Destroy existing chart if it exists
            if (window.examScoresChart) {
                window.examScoresChart.destroy();
            }
            
            window.examScoresChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Average Score',
                            data: avgScores,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Highest Score',
                            data: highScores,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Lowest Score',
                            data: lowScores,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Score (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Exam Title'
                            }
                        }
                    }
                }
            });
        }
        
        // Show student details
        function showStudentDetails(studentId) {
            // Show the student detail card
            const detailCard = document.getElementById('studentDetailCard');
            detailCard.style.display = 'block';
            
            // Fetch student data
            fetch(`/users/${studentId}`)
                .then(response => response.json())
                .then(student => {
                    document.getElementById('studentDetailName').textContent = `Student Details: ${student.name}`;
                    
                    // Fetch student's results
                    return fetch(`/results?studentId=${studentId}`);
                })
                .then(response => response.json())
                .then(results => {
                    // Update student exams table
                    updateStudentExamsTable(results);
                    
                    // Create student progress chart
                    createStudentProgressChart(results);
                })
                .catch(error => {
                    console.error('Error loading student details:', error);
                    showError('Failed to load student details: ' + error.message);
                });
        }
        
        // Update student exams table
        function updateStudentExamsTable(results) {
            const tableBody = document.getElementById('studentExamsTable');
            tableBody.innerHTML = '';
            
            // Sort results by date (newest first)
            results.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            results.forEach(result => {
                // Find exam title
                const exam = allExams.find(e => e.id === result.examId) || { title: 'Unknown Exam' };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${exam.title}</td>
                    <td>${new Date(result.date).toLocaleDateString()}</td>
                    <td>${result.score !== null ? result.score + '%' : 'Not completed'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Create student progress chart
        function createStudentProgressChart(results) {
            const ctx = document.getElementById('studentProgressChart').getContext('2d');
            
            // Filter results with scores and sort by date
            const validResults = results
                .filter(result => result.score !== null)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Prepare data for chart
            const labels = validResults.map(result => {
                const exam = allExams.find(e => e.id === result.examId) || { title: 'Unknown' };
                return exam.title;
            });
            
            const scores = validResults.map(result => result.score);
            
            // Destroy existing chart if it exists
            if (window.studentProgressChart) {
                window.studentProgressChart.destroy();
            }
            
            window.studentProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score Progress',
                        data: scores,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Score (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Exams'
                            }
                        }
                    }
                }
            });
        }
        
        // Show exam details
        function showExamDetails(examId) {
            // Show the exam detail card
            const detailCard = document.getElementById('examDetailCard');
            detailCard.style.display = 'block';
            
            // Find exam in the list
            const exam = allExams.find(e => e.id === examId) || { title: 'Unknown Exam' };
            document.getElementById('examDetailTitle').textContent = `Exam Details: ${exam.title}`;
            
            // Fetch exam results
            fetch(`/results?examId=${examId}`)
                .then(response => response.json())
                .then(results => {
                    // Create score distribution chart
                    createScoreDistributionChart(results);
                    
                    // Create question performance chart (if detailed results available)
                    createQuestionPerformanceChart(results, examId);
                })
                .catch(error => {
                    console.error('Error loading exam details:', error);
                    showError('Failed to load exam details: ' + error.message);
                });
        }
        
        // Create score distribution chart
        function createScoreDistributionChart(results) {
            const ctx = document.getElementById('scoreDistributionChart').getContext('2d');
            
            // Filter results with scores
            const validResults = results.filter(result => result.score !== null);
            
            // Create score ranges
            const ranges = [
                { min: 0, max: 20, label: '0-20%', count: 0 },
                { min: 21, max: 40, label: '21-40%', count: 0 },
                { min: 41, max: 60, label: '41-60%', count: 0 },
                { min: 61, max: 80, label: '61-80%', count: 0 },
                { min: 81, max: 100, label: '81-100%', count: 0 }
            ];
            
            // Count scores in each range
            validResults.forEach(result => {
                const score = result.score;
                for (const range of ranges) {
                    if (score >= range.min && score <= range.max) {
                        range.count++;
                        break;
                    }
                }
            });
            
            // Prepare data for chart
            const labels = ranges.map(range => range.label);
            const data = ranges.map(range => range.count);
            
            // Destroy existing chart if it exists
            if (window.scoreDistributionChart) {
                window.scoreDistributionChart.destroy();
            }
            
            window.scoreDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Students',
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(255, 205, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(54, 162, 235, 0.7)'
                        ],
                        borderColor: [
                            'rgb(255, 99, 132)',
                            'rgb(255, 159, 64)',
                            'rgb(255, 205, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(54, 162, 235)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Score Distribution'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Score Range'
                            }
                        }
                    }
                }
            });
        }
        
        // Create question performance chart
        function createQuestionPerformanceChart(results, examId) {
            const ctx = document.getElementById('questionPerformanceChart').getContext('2d');
            
            // Find exam in the list
            const exam = allExams.find(e => e.id === examId);
            if (!exam) return;
            
            // Filter results with detailed results
            const validResults = results.filter(result => 
                result.detailedResults && Array.isArray(result.detailedResults));
            
            if (validResults.length === 0) {
                // If no detailed results, show a message
                if (window.questionPerformanceChart) {
                    window.questionPerformanceChart.destroy();
                }
                
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No detailed question data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // Prepare data for chart
            const questionIds = exam.questionIds || [];
            const labels = questionIds.map((_, index) => `Q${index + 1}`);
            
            // Calculate correct answer percentage for each question
            const correctPercentages = questionIds.map((questionId, index) => {
                let correct = 0;
                let total = 0;
                
                validResults.forEach(result => {
                    if (result.detailedResults && result.detailedResults[index]) {
                        total++;
                        if (result.detailedResults[index].correct) {
                            correct++;
                        }
                    }
                });
                
                return total > 0 ? (correct / total) * 100 : 0;
            });
            
            // Destroy existing chart if it exists
            if (window.questionPerformanceChart) {
                window.questionPerformanceChart.destroy();
            }
            
            window.questionPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Correct Answer Percentage',
                        data: correctPercentages,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Question Performance'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Correct Answers (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Questions'
                            }
                        }
                    }
                }
            });
        }
        
        // Filter students
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const rows = document.getElementById('studentPerformanceTable').getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const studentId = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
                const studentName = rows[i].getElementsByTagName('td')[1].textContent.toLowerCase();
                
                if (studentId.includes(searchTerm) || studentName.includes(searchTerm)) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }
        
        // Filter exams
        function filterExams() {
            const searchTerm = document.getElementById('examSearch').value.toLowerCase();
            const rows = document.getElementById('examStatisticsTable').getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const examId = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
                const examTitle = rows[i].getElementsByTagName('td')[1].textContent.toLowerCase();
                
                if (examId.includes(searchTerm) || examTitle.includes(searchTerm)) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }
        
        // Show error message
        function showError(message) {
            alert(message);
        }
    </script>
</body>
</html>